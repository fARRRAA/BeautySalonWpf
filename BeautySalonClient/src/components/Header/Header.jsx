import { Link } from 'react-router-dom'
import { useEffect, useState, useRef } from 'react'
import h from './Header.module.css'
import { useCart } from '../../hooks/useCart'
import { useCartActions } from '../../hooks/useCartAction'
import { useSelector } from 'react-redux'
import { MiniCart } from './MiniCart'
import { useAuth } from '../../hooks/useAuth'

export function Header() {
    const { items, totalItems, loading } = useCart();
    const { fetchUserCart } = useCartActions();
    const user = useAuth();
    const [showMiniCart, setShowMiniCart] = useState(false);
    const miniCartTimeoutRef = useRef(null);
    const [scrolled, setScrolled] = useState(false);
    const [hidden, setHidden] = useState(false);
    const lastScrollY = useRef(0);

    useEffect(() => {
        if (user && user.id) {
            fetchUserCart(user.id);
        }
    }, [user, fetchUserCart]);

    // Функция для отслеживания скролла и управления классами хедера
    useEffect(() => {
        const handleScroll = () => {
            const currentScrollY = window.scrollY;

            // Определяем, скроллит ли пользователь вниз или вверх
            if (currentScrollY > lastScrollY.current) {
                // Скролл вниз - скрываем хедер
                setHidden(currentScrollY > 100);
            } else {
                // Скролл вверх - показываем хедер
                setHidden(false);
            }

            // Если прокрутили больше 30px, добавляем класс scrolled
            setScrolled(currentScrollY > 30);

            lastScrollY.current = currentScrollY;
        };

        window.addEventListener('scroll', handleScroll, { passive: true });

        return () => {
            window.removeEventListener('scroll', handleScroll);
        };
    }, []);

    const handleMouseEnter = () => {
        clearTimeout(miniCartTimeoutRef.current);
        setShowMiniCart(true);
    };

    const handleMouseLeave = () => {
        miniCartTimeoutRef.current = setTimeout(() => {
            setShowMiniCart(false);
        }, 300);
    };

    // Динамически формируем классы для хедера
    const headerClasses = `${h.header} ${scrolled ? h.scrolled : ''} ${hidden ? h.hidden : ''}`;

    return (
        <>
            <header className={headerClasses}>
                <div className="container">
                    <div className={h.bottomheader}>
                        <div className={h.header_social}>
                            <Link to="">

                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="24" height="24" rx="12" fill="white" />
                                    <path d="M13.3197 20.5724V11.9991H15.6863L15.9999 9.04464H13.3197L13.3237 7.56592C13.3237 6.79537 13.3969 6.38249 14.5037 6.38249H15.9832V3.42773H13.6162C10.7731 3.42773 9.77244 4.86094 9.77244 7.27115V9.04497H8.00024V11.9994H9.77244V20.5724H13.3197Z" fill="black" />
                                </svg>

                            </Link>
                            <Link to="">


                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="24" height="24" rx="12" fill="white" />
                                    <rect x="3" y="3" width="18" height="18" rx="9" fill="white" />
                                    <path d="M12.0008 3C9.55657 3 9.24981 3.01069 8.2898 3.05438C7.33167 3.09825 6.67766 3.24994 6.10541 3.4725C5.51346 3.70238 5.01133 4.00989 4.51108 4.51033C4.01045 5.01058 3.70294 5.51271 3.47232 6.10447C3.24919 6.67691 3.09731 7.33111 3.05419 8.28887C3.01125 9.24888 3 9.55582 3 12.0001C3 14.4444 3.01088 14.7502 3.05438 15.7102C3.09844 16.6683 3.25013 17.3223 3.4725 17.8946C3.70257 18.4865 4.01007 18.9887 4.51052 19.4889C5.01058 19.9895 5.51271 20.2978 6.10428 20.5277C6.67691 20.7502 7.33111 20.9019 8.28905 20.9458C9.24906 20.9895 9.55563 21.0002 11.9997 21.0002C14.4442 21.0002 14.75 20.9895 15.71 20.9458C16.6681 20.9019 17.3229 20.7502 17.8955 20.5277C18.4873 20.2978 18.9887 19.9895 19.4887 19.4889C19.9894 18.9887 20.2969 18.4865 20.5275 17.8948C20.7487 17.3223 20.9006 16.6681 20.9456 15.7104C20.9888 14.7504 21 14.4444 21 12.0001C21 9.55582 20.9888 9.24906 20.9456 8.28905C20.9006 7.33092 20.7487 6.67691 20.5275 6.10466C20.2969 5.51271 19.9894 5.01058 19.4887 4.51033C18.9881 4.0097 18.4875 3.70219 17.895 3.4725C17.3212 3.24994 16.6668 3.09825 15.7087 3.05438C14.7487 3.01069 14.4431 3 11.998 3H12.0008Z" fill="black" />
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M11.1951 4.62383C11.3519 4.62359 11.5205 4.62366 11.7025 4.62374L12.0025 4.62383C14.4055 4.62383 14.6903 4.63246 15.6393 4.67558C16.5168 4.71571 16.993 4.86233 17.3103 4.98552C17.7303 5.14865 18.0297 5.34365 18.3445 5.65866C18.6595 5.97366 18.8545 6.27366 19.018 6.69367C19.1412 7.01054 19.288 7.4868 19.328 8.36431C19.3711 9.31307 19.3805 9.59807 19.3805 12C19.3805 14.4019 19.3711 14.6869 19.328 15.6356C19.2879 16.5131 19.1412 16.9894 19.018 17.3063C18.8549 17.7263 18.6595 18.0253 18.3445 18.3402C18.0295 18.6552 17.7305 18.8502 17.3103 19.0133C16.9934 19.137 16.5168 19.2833 15.6393 19.3234C14.6905 19.3665 14.4055 19.3759 12.0025 19.3759C9.59926 19.3759 9.31444 19.3665 8.36568 19.3234C7.48817 19.2829 7.01192 19.1363 6.69448 19.0131C6.27447 18.85 5.97447 18.655 5.65947 18.34C5.34446 18.025 5.14946 17.7257 4.98596 17.3055C4.86277 16.9886 4.71596 16.5124 4.67602 15.6349C4.63289 14.6861 4.62427 14.4011 4.62427 11.9977C4.62427 9.59432 4.63289 9.31082 4.67602 8.36206C4.71614 7.48455 4.86277 7.00829 4.98596 6.69104C5.14909 6.27104 5.34446 5.97103 5.65947 5.65603C5.97447 5.34103 6.27447 5.14603 6.69448 4.98252C7.01173 4.85877 7.48817 4.71252 8.36568 4.67221C9.19594 4.63471 9.51769 4.62346 11.1951 4.62158V4.62383ZM16.8049 6.11961C16.2086 6.11961 15.7249 6.60281 15.7249 7.19925C15.7249 7.79551 16.2086 8.27926 16.8049 8.27926C17.4011 8.27926 17.8849 7.79551 17.8849 7.19925C17.8849 6.60299 17.4011 6.11924 16.8049 6.11924V6.11961ZM7.38228 12.0015C7.38228 9.44911 9.45163 7.37969 12.004 7.37959C14.5565 7.37959 16.6254 9.44905 16.6254 12.0015C16.6254 14.554 14.5567 16.6225 12.0042 16.6225C9.45173 16.6225 7.38228 14.554 7.38228 12.0015Z" fill="white" />
                                    <path d="M12.0013 9.00122C13.658 9.00122 15.0013 10.3443 15.0013 12.0013C15.0013 13.658 13.658 15.0013 12.0013 15.0013C10.3443 15.0013 9.00122 13.658 9.00122 12.0013C9.00122 10.3443 10.3443 9.00122 12.0013 9.00122Z" fill="white" />
                                </svg>


                            </Link>
                        </div>
                        <nav className={h.header_nav}>
                            <Link to="">
                                <p className={h.nav_item}>Главная</p>
                            </Link>
                            <Link to="/services">
                                <p className={h.nav_item}>Услуги</p>

                            </Link>
                            <Link to="/shop">
                                <p className={h.nav_item}>Магазин</p>

                            </Link>
                            <Link to="/">
                                <div className={h.logo}>

                                    <svg width="64" height="48" viewBox="0 0 64 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_1_110)">
                                            <path d="M51.6914 33.7543C51.5695 33.6216 49.0064 30.8634 45.3854 29.4737C46.5585 27.532 47.2343 25.2576 47.2343 22.8281V20.4844C47.2343 19.8372 46.7097 19.3125 46.0625 19.3125H43.7187C41.504 19.3125 39.3785 19.8634 37.48 20.9184C36.3383 16.2092 33.0016 12.7988 32.8316 12.6276C32.6116 12.4059 32.3122 12.2812 32 12.2812C31.6877 12.2812 31.3883 12.4059 31.1683 12.6275C30.9983 12.7987 27.6615 16.2092 26.5198 20.9183C24.6215 19.8634 22.496 19.3125 20.2812 19.3125H17.9375C17.2903 19.3125 16.7656 19.8372 16.7656 20.4844V22.8281C16.7656 25.2576 17.4415 27.532 18.6146 29.4737C14.9936 30.8634 12.4305 33.6216 12.3086 33.7544C11.8981 34.2015 11.897 34.8881 12.3061 35.3366C12.4948 35.5436 16.9947 40.4062 22.625 40.4062C24.3999 40.4062 26.0545 39.9231 27.4947 39.255C29.0147 41.2348 31.3161 42.5384 31.4277 42.6008C31.6055 42.7003 31.8028 42.75 32 42.75C32.1973 42.75 32.3946 42.7002 32.5724 42.6008C32.684 42.5384 34.9854 41.2348 36.5054 39.255C37.9454 39.9231 39.6 40.4062 41.375 40.4062C47.0052 40.4062 51.5051 35.5436 51.694 35.3366C52.103 34.888 52.1019 34.2014 51.6914 33.7543ZM32.0017 15.2416C33.2643 16.8237 35.5156 20.1805 35.5156 24C35.5156 27.8044 33.2601 31.1721 31.9983 32.7584C30.7357 31.1763 28.4843 27.8195 28.4843 24C28.4843 20.1956 30.7398 16.8279 32.0017 15.2416ZM22.625 38.0625C19.2793 38.0625 16.2641 35.7921 14.8638 34.5487C15.8991 33.632 17.8119 32.158 20.0772 31.4445C22.2836 33.8951 25.4143 35.4973 28.9147 35.6969C27.0852 37.0298 24.8874 38.0625 22.625 38.0625ZM19.1093 22.8281V21.6562H20.2812C22.3992 21.6562 24.4159 22.2733 26.1536 23.443C26.1452 23.6275 26.1406 23.8131 26.1406 24C26.1406 27.9271 28.0529 31.3355 29.5204 33.3733C23.7672 33.3002 19.1093 28.5983 19.1093 22.8281ZM32 40.1972C31.3728 39.7802 30.3532 39.0282 29.5669 38.0956C30.5961 37.4202 31.4275 36.7231 31.9999 36.1966C32.5722 36.7231 33.4037 37.4202 34.4329 38.0956C33.6466 39.0284 32.6268 39.7804 32 40.1972ZM37.8593 24C37.8593 23.8131 37.8547 23.6275 37.8464 23.443C39.584 22.2733 41.6008 21.6562 43.7187 21.6562H44.8906V22.8281C44.8906 28.5983 40.2327 33.3002 34.4796 33.3733C35.9471 31.3355 37.8593 27.9271 37.8593 24ZM41.375 38.0625C38.9195 38.0625 36.6633 36.8381 35.0929 35.6964C38.5902 35.495 41.7179 33.8934 43.9229 31.4445C46.1898 32.1586 48.1036 33.6342 49.1381 34.5503C47.7423 35.7941 44.7358 38.0625 41.375 38.0625Z" fill="#6B0606" />
                                            <path d="M32 5.25C31.3528 5.25 30.8281 5.77469 30.8281 6.42188V8.76562C30.8281 9.41281 31.3528 9.9375 32 9.9375C32.6472 9.9375 33.1719 9.41281 33.1719 8.76562V6.42188C33.1719 5.77469 32.6472 5.25 32 5.25Z" fill="#6B0606" />
                                            <path d="M24.2823 12.2813L22.625 10.624C22.1674 10.1663 21.4254 10.1663 20.9678 10.624C20.5101 11.0817 20.5101 11.8236 20.9678 12.2813L22.625 13.9385C23.0826 14.3961 23.8246 14.3963 24.2823 13.9385C24.7399 13.4809 24.7399 12.7389 24.2823 12.2813Z" fill="#6B0606" />
                                            <path d="M43.0322 10.624C42.5746 10.1663 41.8326 10.1663 41.3749 10.624L39.7177 12.2813C39.2601 12.7389 39.2601 13.4809 39.7177 13.9385C40.1753 14.3962 40.9173 14.3962 41.375 13.9385L43.0322 12.2813C43.4898 11.8236 43.4898 11.0817 43.0322 10.624Z" fill="#6B0606" />
                                        </g>
                                        <defs>
                                            <clipPath id="clip0_1_110">
                                                <rect width="40" height="40" fill="white" transform="translate(12 4)" />
                                            </clipPath>
                                        </defs>
                                    </svg>
                                </div>
                            </Link>
                            <Link to="/about">
                                <p className={h.nav_item}>О нас</p>

                            </Link>

                            <Link to="/contacts">
                                <p className={h.nav_item}>Контакты</p>

                            </Link>
                            <Link to="/book">
                                <p className={h.nav_item}>Записаться</p>

                            </Link>
                        </nav>
                        <div className={h.header_btns}>
                            <div className={h.button}>
                                <div
                                    className={h.cart_wrapper}
                                    onMouseEnter={handleMouseEnter}
                                    onMouseLeave={handleMouseLeave}
                                >
                                    <Link to="/cart">
                                        <div className={h.cart_btn}>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M7 18C5.9 18 5.01 18.9 5.01 20C5.01 21.1 5.9 22 7 22C8.1 22 9 21.1 9 20C9 18.9 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.63L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 5.48C20.96 5.34 21 5.17 21 5C21 4.45 20.55 4 20 4H5.21L4.27 2H1ZM17 18C15.9 18 15.01 18.9 15.01 20C15.01 21.1 15.9 22 17 22C18.1 22 19 21.1 19 20C19 18.9 18.1 18 17 18Z" fill="black" />
                                            </svg>
                                            {loading ? (
                                                <span className={`${h.cart_counter} ${h.loading}`}>...</span>
                                            ) : totalItems > 0 && (
                                                <span className={h.cart_counter}>{items.length}</span>
                                            )}
                                        </div>
                                    </Link>
                                    {showMiniCart && (
                                        <MiniCart />
                                    )}
                                </div>
                            </div>
                            {
                                user.isAuth &&
                                <div className={h.button}>
                                    <Link to="/user/profile">
                                        <div className={h.user_btn}>

                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0C18.6276 0 24 4.9584 24 11.0753C24.0041 13.6313 23.0464 16.1094 21.2904 18.0859L21.3144 18.1103L21.156 18.2343C20.0306 19.4627 18.6282 20.4496 17.0467 21.126C15.4653 21.8024 13.743 22.152 12 22.1505C8.46 22.1505 5.28001 20.7362 3.08401 18.488L2.84401 18.2332L2.68561 18.1114L2.70961 18.0848C0.953896 16.1085 -0.00384279 13.6309 1.15885e-05 11.0753C1.15885e-05 4.9584 5.37241 0 12 0ZM12 16.6129C9.768 16.6129 7.7508 17.2686 6.2484 18.1701C7.90751 19.3185 9.92612 19.9381 12 19.9355C14.0739 19.9381 16.0925 19.3185 17.7516 18.1701C16.0348 17.155 14.0389 16.6146 12 16.6129ZM12 2.21505C10.1934 2.21501 8.42351 2.68544 6.89367 3.57227C5.36383 4.45911 4.13617 5.72636 3.3518 7.22836C2.56743 8.73035 2.25817 10.4061 2.45959 12.0631C2.66101 13.7201 3.36491 15.2909 4.49041 16.5952C6.43561 15.3071 9.09 14.3979 12 14.3979C14.91 14.3979 17.5644 15.3071 19.5096 16.5952C20.6351 15.2909 21.339 13.7201 21.5404 12.0631C21.7418 10.4061 21.4326 8.73035 20.6482 7.22836C19.8638 5.72636 18.6362 4.45911 17.1063 3.57227C15.5765 2.68544 13.8066 2.21501 12 2.21505ZM12 4.43011C13.273 4.43011 14.4939 4.89685 15.3941 5.72766C16.2943 6.55846 16.8 7.68528 16.8 8.86022C16.8 10.0352 16.2943 11.162 15.3941 11.9928C14.4939 12.8236 13.273 13.2903 12 13.2903C10.727 13.2903 9.50606 12.8236 8.60589 11.9928C7.70572 11.162 7.2 10.0352 7.2 8.86022C7.2 7.68528 7.70572 6.55846 8.60589 5.72766C9.50606 4.89685 10.727 4.43011 12 4.43011ZM12 6.64516C11.3635 6.64516 10.753 6.87854 10.3029 7.29394C9.85286 7.70934 9.6 8.27275 9.6 8.86022C9.6 9.44769 9.85286 10.0111 10.3029 10.4265C10.753 10.8419 11.3635 11.0753 12 11.0753C12.6365 11.0753 13.247 10.8419 13.6971 10.4265C14.1471 10.0111 14.4 9.44769 14.4 8.86022C14.4 8.27275 14.1471 7.70934 13.6971 7.29394C13.247 6.87854 12.6365 6.64516 12 6.64516Z" fill="black" />
                                            </svg>

                                        </div>
                                    </Link>
                                </div>
                            }
                            {
                                !user.isAuth &&
                                <div className={h.button}>
                                    <Link to="/login">
                                        <div className={h.auth_btn}>

                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M12 24V21.3333H21.3333V2.66667H12V0H21.3333C22.0667 0 22.6947 0.261333 23.2173 0.784C23.74 1.30667 24.0009 1.93422 24 2.66667V21.3333C24 22.0667 23.7391 22.6947 23.2173 23.2173C22.6956 23.74 22.0676 24.0009 21.3333 24H12ZM9.33333 18.6667L7.5 16.7333L10.9 13.3333H0V10.6667H10.9L7.5 7.26667L9.33333 5.33333L16 12L9.33333 18.6667Z" fill="black" />
                                            </svg>
                                        </div>
                                    </Link>
                                </div>
                            }

                        </div>
                    </div>
                </div>
            </header>

            {/* Добавляем отступ, чтобы контент не перекрывался фиксированным хедером */}
            <div className={h.header_spacer}></div>
        </>
    )
}


